#region Prolog
vNow     = TIMST (NOW(), '\Y\m\d\h\i\s' );
# User infos
vUser = 'apikey';
vAPIKey = 'azE6dXNyXzcwNzk3OTVmLTAwMzMtMzM0OS1hZjEzLTVjOTg4NzliYmQ0NTpFQXB4SlpNL01tRG00YVFJN3dLaGxVWFArWm1rMEo2dGVhSE1sNTNwU3RnPTpQSjE0' ;
vCredentials = vUser | ':' | vAPIKey;
# Env infos
vHost ='https://eu-central-1.planninganalytics.saas.ibm.com';
vTenant = 'DDZZBR27IKOU' ;
vDBS = 'PAaaS_Test';
vDBT = 'Test_Git' ;

##################### Alternative for 2 environments 
## Th odata type of the source view must be as followed:   "@odata.type": "#ibm.tm1.api.v1.MDXView",
## The http request (GET type) must be as followed : https://eu-central-1.planninganalytics.saas.ibm.com/api/DDZZBR27IKOU/v0/tm1/Test_Git/api/v1/Cubes('plan_BudgetPlan')/Views('01 - Small')
## The strategy is to:
## 1 - retrieve the MDX expression from the source in the body response of the get request  - e.g. : "MDX": "SELECT my very long MDX expression from my source app)",
## 2 - create the view in the target environnement
## 3 - Retreive data from the source view
## 4 - Insert the previoulsy retreived data  in the target
# Test POST 
# sTokenUrl = vHost| '/api/'| vTenant | '/v0/tm1/' | vDBS | '/api/v1/Cubes('|CHAR(39)|'plan_BudgetPlan'|CHAR(39)|')/Views('|CHAR(39)|'01 - Small'|CHAR(39)|')/tm1.Execute?$expand=Cells' ;
# sTokenUrlS = vHost| '/api/'| vTenant | '/v0/tm1/' | vDBS | '/api/v1/Cubes('|CHAR(39)|'plan_BudgetPlan'|CHAR(39)|')/Views('|CHAR(39)|'01 - Small'|CHAR(39)|')/tm1.Execute?$expand=Axes($expand=Hierarchies($select=Name),Tuples($expand=Members($select=Name))),Cells($select=Ordinal,Value)';
sTokenUrlS = vHost| '/api/'| vTenant | '/v0/tm1/' | vDBS | '/api/v1/Cubes('|CHAR(39)|'plan_BudgetPlan'|CHAR(39)|')/Views('|CHAR(39)|'01 - Small'|CHAR(39)|')';
ExecuteHttpRequest( 'POST', sTokenUrlS , '-u '| vCredentials , '-h Content-Type:application/json; charset=utf-8' );

nResponseCode = HttpResponseGetStatusCode();
# # sResponseHeader = HttpResponseGetHeader('Content-Type' );
sResponseBody  = HttpResponseGetBody();
nLongBody = LONG( sResponseBody );

# # Get the Axes and cells datas
nGetAxes = SCAN( '"Axes":' , sResponseBody); 
nGetDatas = SCAN( '"Cells":', sResponseBody );

sGetAxes = SUBST( sResponseBody, nGetAxes , nGetDatas - nGetAxes );
sGetDatas = SUBST( sResponseBody , nGetDatas +8 , nLongBody );

# ASCIIOutput('/Output/body_POST.json', NumberToString( nGetCellsetID) , NumberToString( nResponseCodeCellsetID) , NumberToString( LONG(sResponseBodyCellsetID) ) , sGetCellsetID );
ASCIIOutput('/Output/body_POST.json' , 'sGetAxes' ,  sGetAxes , 'sGetDatas' , sGetDatas );
# ASCIIOutput('/Output/body_POST.json', NumberToString(nResponseCode) , sResponseBody);

###----------------------------------------------------------------------------------------------------------------------###
# Pour envoyer les données il faut créer un tuple par cellule.
# Il faut donc 

# Send data in target using the tm1.Update call and a tuple
sDatas = '
	{"Cells":[
	    {"Tuple@odata.bind": [
	        "Dimensions(''plan_version'')/Hierarchies(''plan_version'')/Elements(''FY 2004 Budget'')",
	        "Dimensions(''plan_business_unit'')/Hierarchies(''plan_business_unit'')/Elements(''10300'')",
	        "Dimensions(''plan_department'')/Hierarchies(''plan_department'')/Elements(''105'')",
	        "Dimensions(''plan_chart_of_accounts'')/Hierarchies(''plan_chart_of_accounts'')/Elements(''61015'')",
	        "Dimensions(''plan_exchange_rates'')/Hierarchies(''plan_exchange_rates'')/Elements(''local'')",
            "Dimensions(''plan_source'')/Hierarchies(''plan_source'')/Elements(''input'')",
	        "Dimensions(''plan_time'')/Hierarchies(''plan_time'')/Elements(''Jan-2004'')"
	        ]
	    }
    ],
	"Value":"1234"}
';

######################
# Sen Data   - /api/v1/Cubes('Couts')/tm1.Update
sTokenUrlCellsetID = vHost| '/api/'| vTenant | '/v0/tm1/' | vDBT | '/api/v1/Cubes(''plan_BudgetPlan'')//tm1.Update';
ExecuteHttpRequest( 'POST', sTokenUrlCellsetID , '-u '| vCredentials , '-h Content-Type:application/json' , '-d' | sDatas );
# Parse body to get the cellsetID
sResponseBodyCellsetID = HttpResponseGetBody();
nResponseCodeCellsetID = HttpResponseGetStatusCode();
nGetCellsetID = SCAN( '"ID":' , sResponseBodyCellsetID); 
sGetCellsetID =SUBST( sResponseBodyCellsetID, nGetCellsetID +6 , (LONG(sResponseBodyCellsetID) - nGetCellsetID) -7);

ASCIIOutput('/Output/body_POST.json', NumberToString( nGetCellsetID) , NumberToString( nResponseCodeCellsetID) , NumberToString( LONG(sResponseBodyCellsetID) ) , sGetCellsetID );

#endregion